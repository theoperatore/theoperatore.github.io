---
layout: post
title: Email-only Authentication with Firebase?!
comments: false
---

While working on a pet project I got to a point where I needed to start thinking about user authentication.

I knew I wanted it to be simple for the user but also somewhat secure. Since I'm not storing any banking or personal information, it was suggested to me to use an email-only authentication method as an easy and unobtrusive alternative to the traditional email & password approach.

Users will be authenticated per device for 2 months before being logged out automatically and will only have to log into their email accounts in order to log into my project.

If they're going to forget their password and have to reset it anyway, then the whole app might as well use that flow for authentication and trim out the "Reset your Password" stuff.

A little bit about the project: it uses [Firebase](https://www.firebase.com) for persistence and authentication. The whole thing will be hosted on [Github Pages](http://pages.github.com) because, hey, it's easy.

Out of all the methods Firebase provides to authenticate a user, the only one that would work for what I want is [custom authentication](https://www.firebase.com/docs/web/guide/login/custom.html).

However, since I don't have a proper backend, custom auth is out because the generated tokens won't be secure (store a secrect key client-side? no thanks).

This leaves me stuck with an email and password system...ugh.

### Trickery!

I still need to use the Email & Password system, but I can perform a little hack-ery to get the log in flow correct.

By noticing that the Email & Password authentication method used by Firebase has a built-in "Reset your Password" function, I can repurpose that utility to suit my needs.

Upon invoking this function (for example, when a user enters their email address into the log in form), Firebase will generate a unique token (which can be used to authenticate an existing user) *and* send an email containing the token to the user.

I changed the subject of the email from "Password Reset" to "Finish Logging in!" and created a URL (with the token appeneded) that points to a landing page where I can grab the token and finish authenticating the user.

Whoop! Firebase email-only client-side authentication! Mission Accomplished.

This works for existing users, but what about brand new users who still need to sign up?

### Email-only Sign Up

To create any user using Firebase's Email & Password system, a user needs an email address and a password. However the whole idea is for this application to be password-less.

A solution I found was to generate a random password and try to create the user using their given email address and this generated password.

Since Firebase allows a user to use either their password or a token generated by the reset password function to authenticate, it doesn't matter that the initial password is forever unknown to the user. 

More importantly, the generated password isn't stored anywhere client side because a user is only ever going to use the token from the "Reset your Password" email.

I generate a random password with something like:

{% highlight javascript %}

function generate() {
  var chars = "0123456789abcdefghijklmnopqrstuvwxyz-ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  var pass = "";

  for (var i = 0; i < 32; i++) {
    pass += chars[Math.floor(Math.random() * chars.length)];
  }

  return pass;
}
{% endhighlight %}

Then use that in conjunction with the inputted email address to create the user. Once the user is successfully created, we can call the "Reset your Password" function to log the user into the app.

Nice!

### Caveats 

In addition to the normal email-only issues with security and such, there is one important part of this flow that wasn't mentioned above:

*The landing page to authenticate a user needs an email address, which the landing page doesn't have.*

Unless you append the user's email address into the url like with the token, I suggest a different course of action: `localStorage`.

Whenever a "Reset your Password" function is called, store the user's email address in `localStorage`. Then on the landing page, read from the `localStorage` to grab the email, grab the token from the url and authenticate away.

After a successful authentication, it might be wise to remove the stored email.

### Example!

Above I outline the theory behind the hack, but examples are nice too. Here are examples of `createUser()`, `sendEmail()`, and `authUser()` functions that will be used to facilitate email-only log in with Firebase. Below them are `onSubmit()` functions that exemplify their use.

This might actually be a good time to use [Promises](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise).

While you could nest the reset password function in the handler for the create user function, it might be easier to read if all of the Fireabse funtions returned a Promise.

Plus, when creating a new user I only want to send an email with a login token if their account was successfully created&mdash;Promises help with that too.

All of the following functions are essentially wrappers for the Firebase email & password authentication functions:

{% highlight javascript %}
///////////////////////////////////////////////////////////////////////////////
//
// create user function
//
///////////////////////////////////////////////////////////////////////////////
function createUser(email, password) {
  return new Promise(function(resolve, reject) {

    // try to create a new user
    FirebaseRef.createUser({
      email : email,
      password : password
    }, 

    // handle the outcome; reject if there is an error, 
    // otherwise resolve with the user's auth payload
    function(err, data) {
      if (err) {
        reject(err);
      }
      else {
        resolve(data);
      }
    })
  })
}

///////////////////////////////////////////////////////////////////////////////
//
// repurpose firebase reset email funtion to be used for loggin in
//
///////////////////////////////////////////////////////////////////////////////
function sendEmail(email) {
  return new Promise(function(resolve, reject) {

    // try to send the email
    FirebaseRef.resetPassword({
      email : email
    }, 

    // when it completes, reject or resolve accordingly
    function(err) {
      if (err) {
        reject(err);
      }
      else {
        resolve("Email sent successfully");
      }
    })
  })
}

///////////////////////////////////////////////////////////////////////////////
//
// function to authenticate a user
//
///////////////////////////////////////////////////////////////////////////////
function authUser(email, token) {
  return new Promise(function(resolve, reject) {

    // try to authenticate the user
    FirebaseRef.authWithPassword({
      email : email,
      password : token
    },
    
    // handle the result; all of these functions are pretty similar,
    // almost as if Firebase should implement these functions to return
    // promises themselves...:)
    function(err, auth) {
      if (err) {
        reject(err);
      }
      else {
        resolve(auth)
      }
    })
  })
}
{% endhighlight %}

Now that those are built, we can use them to create and authenticate users using only their email address.

Say we wanted to create a new user. The user would enter their email address into the form, then hit submit:

{% highlight javascript %}
// assuming we have access to those functions defined above...
// and access to generate() to get a random password.

// this function is called when the form to sign up is submitted
function onSubmit() {
  var email = document.querySelector('#email').value;
  var pass = generate();

  // try creating a user
  createUser(email, pass).then(function(auth) {

    // cool! new user has been created
    // respond to a new user signing up
    // send token in email
    return sendEmail(email);

  }).then(function(result) {

    // result => "Email sent Successfully"
    console.log(result);

    // save email to local storage for later
    // email should probably be escaped, just in case..
    localStorage.setItem("__someExampleKey", email);

  }).catch(function(err) {

    // oh noes! something bad happened!
    // tell the user and log the error.
    // err => FirebaseErrorObject
    console.log(err);
  })
}
{% endhighlight %}

If everything goes acording to plan, the user is sent an email after signing up. If there is an error anywhere, the `catch()` will handle it and stop the process.

Conversely, say the user wants to log into their already existing account. They enter their email address, and hit the "Log In" button and:

{% highlight javascript %}
function onSubmit() {
  var email = document.querySelector('#email').value;

  // send the email!
  sendEmail(email).then(function(result) {
      
    // result => "Email Sent Successfully";
    // save the email for later log in
    console.log(result);
    localStorage.setItem("__someExampleKey", email);

  }).catch(function(err) {
    
    // Crazy bad things happened while trying to send the email!
    // tell the user
    console.log(err);

  }) 
}
{% endhighlight %}

Either way, the user will get an email. When they click the link, they get directed to a landing page which will handle the rest of the authentication:

{% highlight javascript %}
// resolve the authentication immediately
(function resolveAuth(document) {
  
  // assuming the URL is something like: example.com/login?t=12345abcde
  var tok = document.location.search.substr(1).split('=')[1];
  var em  = localStorage.getItem('__exampleEmailKey');

  // auth the user
  authUser(em, tok).then(function(authData) {

    // tell the user the good news! and possibly redirect to another page?
    console.log(authData);

  }).catch(function(err) {

    // terrible things happened while trying to auth;
    // handle them! Tell the user!
    console.log(err);

  }).then(function() {

    // regardless, delete stored email address from localStorage
    localStorage.removeItem('__exampleEmailKey');

  })

})(document);
{% endhighlight %}

Simple Tomfoolery.

### And that's it!

There's my hack to give client-side email-only authentication using Firebase.

The goal of this is to:

- prevent users from having to remember yet **another** password
- keep users distinct while maintaining an "acceptable" level of security
- provide a solution to email-only authentication without a proper back-end

If you have access to any sort of server and you want email-only authentication, then you should really be using [custom authentication](https://www.firebase.com/docs/web/guide/login/custom.html) and use the built-in authentication the way it was intended to be used.

If you're wondering about Promises, more info can be found in this [HTML5 Rocks article by Jake Archibald](http://www.html5rocks.com/en/tutorials/es6/promises/)

Thanks for reading!