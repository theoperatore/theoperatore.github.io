<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>2D Physics Camera and Screen Shake</title>
    <meta name="viewport" content="width=device-width">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,400italic' rel='stylesheet' type='text/css'>

    <!-- Mathjax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

    <body>

      <div class="site">
        <header>
  <div class="header-content">
    <h1 class="title"><a href="/">Alex.Petersen</a></h1>

    <img src="/assets/icon-menu.svg" id="menu-toggle">

    <ul id="nav">
      <!--<li><a href="/about/">about</a></li>-->
      <li><a href="/">posts</a></li>
      <li><a href="/#projects">projects</a></li>
      <li><a href="http://careers.stackoverflow.com/anpetersen">resume</a>
    </ul>
  </div>
</header>
        <div class="post-container">
<div class="post">
  <p>I watched <a href="https://www.youtube.com/watch?v=AJdEqssNZ-U">this video</a> (a talk by Jan Willem Nijman from Vlambeer; 30 tiny tricks that will make your action game better) and got really excited about screen shake (too excited probably). It makes everything feel like it has weight and makes you, the player, feel really awesome. Here follows my take on making a camera for a Javascript game using the <code>&lt;canvas&gt;</code> and implementing screen shake. GO!</p>

<p>There seem to be two ways to do screen shake:</p>

<ul>
  <li>Shake every object on the screen</li>
  <li>Shake the camera</li>
</ul>

<p>I’m going to focus on the latter and therefore, need to make a camera. But not just any camera, a physics based camera. One with acceleration and velocity and everything.</p>

<p>Let’s get a few things straight first.</p>

<h3 id="world-space-vs-camera-space">World space vs Camera space</h3>

<p>The camera is the window into the world of the game; it defines what the player can and cannot see. By this idea there exists two spaces within the game: world space and camera space.</p>

<p><em>World space</em> is the world in which all of the objects in a game reside; the player’s character, environment, enemies, and any other entities. It is the global coordinate space. Anything that will ever exist in the game will have a starting position based on this coordinate system.</p>

<p><img src="/assets/camera/world-space-edit.png" alt="world space" /><br />
<span class="img-description">Figure 1—world space (blue) with entities; no camera</span></p>

<p><em>Camera space</em> is the bounding area that is viewable at any point in time. Only objects that are within the bounds of the camera space will be visible to the player and drawn on the screen.</p>

<p><img src="/assets/camera/world-space-camera.png" alt="world space" /><br />
<span class="img-description">Figure 2—camera space (in green) viewing a section of world space (blue)</span></p>

<p>Since this is an article about using the <code>&lt;canvas&gt;</code>, the camera is equivalent to the canvas. When drawing, the canvas context assumes camera space. No matter where the camera object is positioned, if the canvas context is called to draw something at (0,0) the object will be at the top left of the screen (because that’s where the origin is for computer graphics).</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// if your camera is defined like this...</span>
<span class="kd">var</span> <span class="nx">camera</span> <span class="o">=</span> <span class="p">{</span>
  
  <span class="c1">// a bunch of properties</span>
  <span class="p">...</span>

  <span class="c1">// position of camera at (400, 400)</span>
  <span class="nx">pos</span> <span class="o">:</span> <span class="p">{</span><span class="nx">x</span> <span class="o">:</span> <span class="mi">400</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">400</span><span class="p">},</span>

  <span class="c1">// get canvas drawing context</span>
  <span class="nx">cvs</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">),</span>
  <span class="nx">ctx</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">cvs</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">),</span>
  <span class="nx">width</span> <span class="o">:</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>  <span class="c1">// 300 px</span>
  <span class="nx">height</span> <span class="o">:</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">height</span> <span class="c1">// 300 px</span>

<span class="p">}</span>

<span class="c1">// sample entity with world space coordinates of (10, 10)</span>
<span class="kd">var</span> <span class="nx">entity1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">pos</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">10</span> <span class="p">},</span>
  <span class="nx">width</span> <span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nx">height</span> <span class="o">:</span> <span class="mi">5</span>
<span class="p">}</span>

<span class="c1">// sample entity with world space coordinates of (530, 530)</span>
<span class="kd">var</span> <span class="nx">entity2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">pos</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">530</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">530</span> <span class="p">},</span>
  <span class="nx">width</span> <span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nx">height</span> <span class="o">:</span> <span class="mi">5</span> 
<span class="p">}</span>

<span class="c1">// drawing assumes camera space; this will draw the entity at (10, 10)</span>
<span class="c1">// on the canvas.</span>
<span class="c1">// This entity should not be visible because the entity is at (10, 10)</span>
<span class="c1">// and the camera is at (400, 400) in world space, yet when this</span>
<span class="c1">// function is run, the entity is visible.</span>
<span class="c1">// WRONG</span>
<span class="nx">camera</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">entity1</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">entity1</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">entity1</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">entity1</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

<span class="c1">// this entity won&#39;t be visible on the screen because it&#39;s x and y coordinates (530, 530) </span>
<span class="c1">// are out of the bounds of the camera (the camera is only 300 px wide and 300px high).</span>
<span class="c1">// However, in the context of the game, this entity should be seen because in world</span>
<span class="c1">// space, entity2 is within the bounds of the camera, but the canvas context assumes </span>
<span class="c1">// camera space, so the entity is drawn outside of the bounds of the canvas.</span>
<span class="c1">// WRONG</span>
<span class="nx">camera</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">entity2</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">entity2</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">entity2</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">entity2</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span></code></pre></div>

<p>On each rendering pass, the game <strong>must</strong> correct entity positions to be relative to the camera’s current position otherwise your entities won’t be drawn correctly. Before diving into correcting for camera space, let’s first define some camera propeties to get rolling with some basic physics.</p>

<h3 id="properties-of-a-physics-based-camera">Properties of a physics based camera</h3>

<p>A camera is just an object of the world space itself; it has a position in world space. Add in some velocity and acceleration, and this camera becomes a physics camera!</p>

<p>The camera is defined (in Javascript) as such:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="kd">var</span> <span class="nx">camera</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>   <span class="c1">// position vectors (acceleration spelled wrong so it all fits!)</span>
<span class="lineno"> 4</span>   <span class="nx">cpos</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
<span class="lineno"> 5</span>   <span class="nx">ppos</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
<span class="lineno"> 6</span>   <span class="nx">acel</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">},</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>   <span class="c1">// dimensions of the camera; how much of the world is visible?</span>
<span class="lineno"> 9</span>   <span class="c1">// set these to the height and width of the canvas</span>
<span class="lineno">10</span>   <span class="nx">height</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span>
<span class="lineno">11</span>   <span class="nx">width</span>  <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="c1">// cutoff point for drawing</span>
<span class="lineno">14</span>   <span class="nx">cullDist</span> <span class="o">:</span> <span class="mi">300</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>   <span class="c1">// should the camera be flush against the walls of the world?</span>
<span class="lineno">17</span>   <span class="nx">bound</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="lineno">18</span>   <span class="nx">maxHeight</span> <span class="o">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span>
<span class="lineno">19</span>   <span class="nx">maxWidth</span>  <span class="o">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientWidth</span>
<span class="lineno">20</span> 
<span class="lineno">21</span> <span class="p">}</span></code></pre></div>

<p>This gives the camera object:</p>

<ul>
  <li><code>cpos</code>, <code>ppos</code>, <code>acel</code> positioning vectors</li>
  <li><code>height</code>, <code>width</code> dimensions for viewing the world space</li>
  <li><code>cullDist</code> a distance in pixels from the extremes of the bounds of the camera to start drawing objects (explained down below) </li>
  <li><code>bound</code> a boolean to determine if the camera will stop scrolling when at the edge of the world</li>
  <li><code>maxHeight</code>, <code>maxWidth</code> the maximum dimensions that the camera is allowed to view</li>
</ul>

<p>Time to figure out what to draw!</p>

<h3 id="drawing-all-the-things">Drawing all the things</h3>

<p>To draw anything, first figure out if the object to draw is within the bounds of the camera. This means calculating the object’s position relative to the current position of the camera. It sounds really hard. Don’t worry. It isn’t.</p>

<p>Subtract the camera’s position from the object’s position. This gives the object’s current position relative to the camera.</p>

<p><img src="/assets/camera/draw-on-camera.png" alt="subtracting vectors" /><br />
<span class="img-description">Figure 3—from world origin (0,0) at top-left corner, subtract the camera’s position vector (c) from the object’s position vector (p) to find the object’s position vector relative to the camera’s position (d)</span></p>

<p>and the code:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="c1">// vector to hold object cpos in camera space (&#39;d&#39; in figure 3)</span>
<span class="lineno">2</span> <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="c1">// convert object&#39;s cpos from world space coordinates to camera space coordinates</span>
<span class="lineno">5</span> <span class="c1">// obj and camera as &#39;p&#39; and &#39;c&#39; in figure 3 respectively</span>
<span class="lineno">6</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">7</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span></code></pre></div>

<p><code>diff</code> now holds the object’s position relative to the camera position; as if the camera’s position is the origin at (0,0).</p>

<p>The canvas drawing context needs the object’s position relative to the camera in order to draw it correctly. As stated previously, the canvas drawing context <em>always</em> assumes camera space. If <code>diff</code> lies within the bounds of the canvas, then when the object is drawn using the canvas context at position <code>diff.x</code> and <code>diff.y</code>, the object will be displayed to the user.</p>

<p><em>Example</em></p>

<p>If <code>obj</code> has current position <code>(3,5)</code> in world space and the camera has position <code>(1,2)</code> in world space, then <code>obj</code> position relative to the camera is:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// vectors from figure 3</span>
<span class="nx">d</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">-</span> <span class="nx">c</span><span class="p">;</span>

<span class="c1">// substituting obj&#39;s position and camera&#39;s position</span>
<span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// solving (3 - 1) for x-coord, and (5 - 2) for y-coord</span>
<span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span></code></pre></div>

<p>In camera space, <code>obj</code> has a position vector <code>(2,3)</code> meaning that if you start at the camera’s position and add 2 to the camera’s x-coordinate and 3 to the camera’s y-coordinate you’ll arrive at the object’s position.</p>

<p>Congratulations! You just performed a coordinate transformation, specifically a coordinate origin translation. Essentially, the world space origin has moved (translated) to be the camera’s current position. The camera’s current position is now the origin for <code>diff</code>.</p>

<p>This is excatly what needs to happen because the canvas context will always assume that (0,0) is the top left of the canvas, and since the canvas is our camera, we have shifted the world space origin to be the the camera’s current position which is the top left of the canvas.</p>

<p><span class="img-description">img showing world space origin moved to camera space?</span></p>

<p>Now that there is a way to translate any entity’s current world space position to camera space, it can be drawn! But first there must be a check to see if the object is actually viewable by checking to see if it’s within the bounds of the camera.</p>

<p>Since the object’s position is now in camera space, the camera bounding box starts at position <code>(0,0)</code> and has extremes <code>(width, height)</code>. This makes bounds checking easy:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// assume &#39;diff&#39; calculated from above and that it</span>
<span class="c1">// holds the position of the entity in camera space</span>
<span class="kd">var</span> <span class="nx">diff</span><span class="p">;</span>

<span class="c1">// check camera bounds</span>
<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
     <span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">)</span> 
<span class="p">{</span>

  <span class="c1">// the object is on screen</span>
  <span class="c1">// draw it to the canvas using the camera space coordinates</span>
  <span class="c1">// because the canvas always assumes camera space</span>
  <span class="p">...</span>

<span class="p">}</span></code></pre></div>

<p><em>Neat. Stuff can be drawn!</em></p>

<p>But if you test this out you might notice that some large objects tend to “pop-in” or “pop-out” when they leave the screen. That’s becasue the camera is culling too early; the camera should start drawing while entities are off-screen in order to have them smoothly enter or exit the player’s view. This is where <code>cullDist</code> comes into play.</p>

<p><img src="/assets/camera/camera-cullDist.png" alt="adding cullDist to the camera" /><br />
<span class="img-description">Figure 4—if an entity lies within the bounds of the camera plus the pink culling field, draw it</span></p>

<p>Just update the camera bounds check to use <code>cullDist</code> and everything is good to go:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// assume we have &#39;diff&#39; calculated from above and that it</span>
<span class="c1">// holds the position of the entity in camera space</span>
<span class="kd">var</span> <span class="nx">diff</span><span class="p">;</span>

<span class="c1">// calculate the new bounds to test</span>
<span class="kd">var</span> <span class="nx">lower</span> <span class="o">=</span> <span class="o">-</span><span class="nx">camera</span><span class="p">.</span><span class="nx">cullDist</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">upperX</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cullDist</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">upperY</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cullDist</span><span class="p">;</span>

<span class="c1">// check camera bounds with cullDist</span>
<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">lower</span> <span class="o">&amp;&amp;</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">upperX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
     <span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">lower</span> <span class="o">&amp;&amp;</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">upperY</span><span class="p">)</span> <span class="p">)</span> 
<span class="p">{</span>

  <span class="c1">// the entity is within the culling field / camera bounds</span>
  <span class="c1">// draw it using the camera space coordinates</span>
  <span class="p">...</span>

<span class="p">}</span></code></pre></div>

<p>Yay! No more popping entities! Almost to the goal of screen shake. Next is making the camera follow an entity and with that a note on integration.</p>

<h3 id="on-integration">On integration</h3>

<p>This article uses a type of numerical integration called <a href="http://en.wikipedia.org/wiki/Verlet_integration">Verlet Integration</a>. </p>

<p>Basically, the integrator takes an object’s current position, previous position, and acceleration (as vectors) and outputs that object’s next position. It doesn’t accept velocity as an input explicitly because it derives that value <em>implicitly</em> from current position and previous position. At any point in time, the object’s next position can be calculated as:</p>

<script type="math/tex; mode=display">% <![CDATA[

\begin{align*}
  & \vec{x_{next}} = 2(\vec{x_{curr}}) - \vec{x_{prev}} + \vec{a}(dt^2) \\
\end{align*}
 %]]></script>

<p>All that’s left is to set the object’s previous position to it’s current postion, and it’s current position to it’s next position:</p>

<script type="math/tex; mode=display">% <![CDATA[

\begin{align*}
  & \vec{x_{prev}} = \vec{x_{curr}} \\
  & \vec{x_{curr}} = \vec{x_{next}} \\
\end{align*}
 %]]></script>

<p>Or in javascript (because that seems to be way less confusing…)</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// these are all vector objects with properties &#39;x&#39; and &#39;y&#39;</span>
<span class="c1">// calculate the new pos vector from curr, prev, accel and time step dt</span>
<span class="nx">next</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">curr</span><span class="p">)</span> <span class="o">-</span> <span class="nx">prev</span> <span class="o">+</span> <span class="p">(</span><span class="nx">accel</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">);</span>

<span class="c1">// set the prev vector for the next update next frame</span>
<span class="nx">prev</span> <span class="o">=</span> <span class="nx">curr</span><span class="p">;</span>

<span class="c1">// set the curr vector to the calculated position for drawing this frame</span>
<span class="nx">curr</span> <span class="o">=</span> <span class="nx">next</span><span class="p">;</span></code></pre></div>

<p>This is similar to <a href="http://en.wikipedia.org/wiki/Euler_method">Euler Integration</a>, but verlet integration doesn’t require velocities explicitly and is dependant on a fixed timestep <code>dt</code>. Other techniques are discussed <a href="http://gafferongames.com/game-physics/integration-basics/">here</a> and should definitely be checked out.</p>

<p>You can use whichever method you prefer, but I just wanted to explain why my objects have <code>cpos</code> (current position vector) and <code>ppos</code> (previous position vector) properties—they’re needed for verlet integration.</p>

<h3 id="follow-that-player">Follow that player!</h3>

<p>I’ve defined above the basis behind implementing a camera and drawing entities that are within the bounds of that camera. If the camera were to move to a different position, the game would show that movement by drawing entities that are withing it’s view frustrum.</p>

<p>But how does the camera move? I could give direct control of the camera to the player (many games do this with the right analog stick on a console or mouse on PC), but let’s have the camera follow the player so that when the player moves, the camera moves too.</p>

<p>While I could update the position of the camera with a point based off of the player’s current position, it would be better (and more physics-y) if I could just tell the camera where it should be, and have it interpolate the distance over many frames. This will allow the camera to smoothly scroll and not jerk to the target location.</p>

<p>Update the camera object!</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// updated camera object for target position</span>
<span class="lineno"> 2</span> <span class="kd">var</span> <span class="nx">camera</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// other properties from above definition</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// target point the camera should be at to follow the player</span>
<span class="lineno"> 8</span>   <span class="nx">target</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="p">}</span></code></pre></div>

<p>Now to move the camera, set <code>camera.target</code> to the desired position and slowly inch the camera’s current position towards the target. I’ll update the camera’s target when the player’s current position gets updated.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// your game loop update function</span>
<span class="lineno"> 2</span> <span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// handle input</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// update camera target position</span>
<span class="lineno"> 8</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno"> 9</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>   <span class="c1">// update camera acceleration</span>
<span class="lineno">12</span>   <span class="p">...</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>   <span class="c1">// update camera position</span>
<span class="lineno">15</span>   <span class="p">...</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>   <span class="c1">// update entity positions / collisions</span>
<span class="lineno">18</span>   <span class="p">...</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>   <span class="c1">// update player positions / collisions</span>
<span class="lineno">21</span>   <span class="p">...</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> 
<span class="lineno">24</span> <span class="p">}</span></code></pre></div>

<p>This will set the target position of the camera to be to the left and up from the player. From the user’s standpoint, as the player moves around, the player will appear to stay in the center of the screen. </p>

<p><em>Note that I intentionally set the camera target position to be based off of the current position of the player <strong>before</strong> updating the player’s position for the current frame. This gives a cool effect of the player running really fast and the camera trying to catch up.</em></p>

<p>To make the player appear locked in a different location, just manipulate the camera’s target position:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="c1">// player appears to stay on the left third of the screen</span>
<span class="lineno">2</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno">3</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="c1">// player appears to stay on the right third of the screen</span>
<span class="lineno">6</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span>
<span class="lineno">7</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span></code></pre></div>

<p>Cool. All that’s left is to implement the smooth panning from the camera’s current position to the camera’s target position. Since this camera is physics based, I’m going to apply a force to the camera in the direction of the target point.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// calculate force in the direction of the target</span>
<span class="nx">accel</span> <span class="o">=</span> <span class="nx">accel</span> <span class="o">+</span> <span class="p">(</span><span class="nx">target</span> <span class="o">-</span> <span class="nx">curr</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span></code></pre></div>

<p>Where <code>accel</code> is the current acceleration vector, <code>curr</code> is the current position vector, <code>target - curr</code> is relative direction vector between the target and the current position, and <code>step</code> is how much of the relative direction vector to add to the current vector.</p>

<p>Instead of setting the camera’s current position to the target position all at once, this function gives the camera a little nudge in the correct direction. It just so happens that using a velocity-like force (<code>target - curr</code>) controlled by the <code>step</code> variable works really well.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// the game loop update function</span>
<span class="lineno"> 2</span> <span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// handle input</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// update camera target position</span>
<span class="lineno"> 8</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno"> 9</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>   <span class="c1">// update camera acceleration -- step is usually great at 0.125</span>
<span class="lineno">12</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
<span class="lineno">13</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>   <span class="c1">// update camera position</span>
<span class="lineno">16</span>   <span class="p">...</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>   <span class="c1">// update entity positions / collisions</span>
<span class="lineno">19</span>   <span class="p">...</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>   <span class="c1">// update player positions / collisions</span>
<span class="lineno">22</span>   <span class="p">...</span>
<span class="lineno">23</span> 
<span class="lineno">24</span> <span class="p">}</span></code></pre></div>

<p>Excellent! Now wherever the player goes, the camera will follow. It is worth mentioning that the camera will follow wherever its <code>target</code> propery points. <code>target</code> could be calculated from the player, an enemy, a scripted scene, a mathematical soup of inputs, etc…go with what you feel.</p>

<p>It’s also worth mentioning that the <code>step</code> value should be tweaked (most likely through trial and error) to find the best “feel” for the camera panning to it’s proper location.</p>

<h3 id="integrating-a-camera-position">Integrating a camera position</h3>

<p>To make this whole thing work correctly, just update the camera’s position just like any other entity. As mentioned above I use verlet integration. Inserting the update code into the update function would look something like this:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// the game loop update function</span>
<span class="lineno"> 2</span> <span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// handle input</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// update camera target position</span>
<span class="lineno"> 8</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno"> 9</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>   <span class="c1">// update camera acceleration -- step is usually great at 0.125</span>
<span class="lineno">12</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
<span class="lineno">13</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>   <span class="c1">// apply some drag</span>
<span class="lineno">16</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">drag</span><span class="p">;</span>
<span class="lineno">17</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">drag</span><span class="p">;</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>   <span class="c1">// update camera position from accel -- verlet integration</span>
<span class="lineno">20</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">;</span>
<span class="lineno">21</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">;</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>   <span class="c1">// update camera next position -- verlet integration</span>
<span class="lineno">24</span>   <span class="kd">var</span> <span class="nx">nextx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">25</span>   <span class="kd">var</span> <span class="nx">nexty</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>   <span class="c1">// remember previous position -- verlet integration</span>
<span class="lineno">28</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="lineno">29</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">ppos</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>   <span class="c1">// update current position -- verlet integration</span>
<span class="lineno">32</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">nextx</span><span class="p">;</span>
<span class="lineno">33</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">nexty</span><span class="p">;</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>   <span class="c1">// reset accel -- verlet integration</span>
<span class="lineno">36</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">37</span>   <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">38</span> 
<span class="lineno">39</span>   <span class="c1">// bound camera to world edges if applicable</span>
<span class="lineno">40</span>   <span class="k">if</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">bound</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">41</span> 
<span class="lineno">42</span>     <span class="c1">// flush camera -- x bounds</span>
<span class="lineno">43</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">maxWidth</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
<span class="lineno">44</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">45</span> 
<span class="lineno">46</span>     <span class="c1">// flush camera -- y bounds</span>
<span class="lineno">47</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">maxHeight</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="lineno">48</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">cpos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="lineno">49</span>   <span class="p">}</span>
<span class="lineno">50</span> 
<span class="lineno">51</span>   <span class="c1">// update entity positions / collisions</span>
<span class="lineno">52</span>   <span class="p">...</span>
<span class="lineno">53</span> 
<span class="lineno">54</span>   <span class="c1">// update player positions / collisions</span>
<span class="lineno">55</span>   <span class="p">...</span>
<span class="lineno">56</span> 
<span class="lineno">57</span> <span class="p">}</span></code></pre></div>

<p>This kinda adds a lot. </p>

<p>It adds in drag on lines 16 and 17 to simulate energy loss in the system, otherwise the game objects would never come to a stop. The variable <code>drag</code> can be any value you want from 0.0 to 1.0. Think of it as the percentage of velocity that is allowed to be kept; 0.93 means that 93% of the velocity is kept while 7% is lost.</p>

<p>Lines 19 to 37 do the actual verlet integration. It is on these lines that the new position of the camera is actually calculated. <code>dt</code> is the change in time since the last update. Since I’m using verlet integration, a <a href="http://gafferongames.com/game-physics/fix-your-timestep/">fixed timestep</a> should be used. I have this set up to accept a <code>dt</code> in milliseconds, so I convert <code>dt</code> to seconds on lines 20 and 21 by multiplying by <code>0.001</code>. I usually set <code>dt</code> to be 16 milliseconds (which corresponds to 1/60th of a second or the length of 1 frame). </p>

<p>The absolute last addition on lines 40 - 49 is binding the camera to the <code>maxHeight</code> and <code>maxWidth</code> properties defined previously. Typically, these two properties define the dimensions of the world space, but they can also be thought of as the dimensions of the world that the camera is allowed to view. </p>

<p>On each frame after updating and running the verlet calculations, the camera’s current position is checked for bounds. These lines first check the upper bounds by setting the camera’s current position to the smaller of the two—the current position or the max bounds. Then the lines check the lower bounds by setting the camera’s current position the larger of the two—the current position or 0. We aren’t using a <code>minHeight</code> or <code>minWidth</code> so 0 is used instead. </p>

<p><em>Note however that this does not prevent the player from moving off camera. This only prevents the camera from viewing something out of bounds. Player-environment collision should be handled elsewhere</em></p>

<p>Now that everything is in place, I can finally get to…</p>

<h3 id="shake">Shake!</h3>

<p>YES! The whole reason I started this endeavor was to code up some juicy screen shake and now the time is finally here. </p>

<p>Turns out, I already covered all of the hard stuff! Implementing screen shake is super simple. There are two requirements:</p>

<ul>
  <li>how intense should the shaking be</li>
  <li>how much to dampen the shaking each frame</li>
</ul>

<p>All three of these requirements will be assembled into an acceleration force that will be applied to the camera. No need to remember the original position of the camera, or calculate new positions from old positions—all of that is already taken care of in the “Follow that player!” section above. Since the shake is just an acceleration force, the target position for the camera does not change so the camera will naturally flow back to its intended position.</p>

<p>Adding more properties to the camera!</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// updated camera object for SCREEN SHAKE!</span>
<span class="lineno"> 2</span> <span class="kd">var</span> <span class="nx">camera</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// other properties from above definition</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// target point the camera should be at to follow the player</span>
<span class="lineno"> 8</span>   <span class="p">...</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>   <span class="c1">// shaking properties</span>
<span class="lineno">11</span>   <span class="nx">strength</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="lineno">12</span>   <span class="nx">damper</span> <span class="o">:</span> <span class="mi">5</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="p">}</span></code></pre></div>

<p>The new properties added will help take care of the two requrements:</p>

<ul>
  <li><code>strength</code> is the strength of the shaking</li>
  <li><code>damper</code> is how much to subtract from <code>strength</code> on each frame</li>
</ul>

<p>Now to add in the screen shake update to the game update function <strong>before</strong> using verlet integration to get the new camera position:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="c1">// the game loop update function</span>
<span class="lineno"> 2</span> <span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3</span>   
<span class="lineno"> 4</span>   <span class="c1">// handle input</span>
<span class="lineno"> 5</span>   <span class="p">...</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="c1">// update camera target position</span>
<span class="lineno"> 8</span>   <span class="p">...</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>   <span class="c1">// update camera acceleration -- step is usually great at 0.125</span>
<span class="lineno">11</span>   <span class="p">...</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="c1">// SCREEN SHAKE</span>
<span class="lineno">14</span>   <span class="k">if</span> <span class="p">(</span><span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="c1">// get random acceleration on the interval [-strength, strength]</span>
<span class="lineno">17</span>     <span class="kd">var</span> <span class="nx">randx</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span><span class="p">;</span>
<span class="lineno">18</span>     <span class="kd">var</span> <span class="nx">randy</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span> <span class="o">-</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span><span class="p">;</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>     <span class="c1">// add in the shaking acceleration</span>
<span class="lineno">21</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">randx</span><span class="p">;</span>
<span class="lineno">22</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">acel</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">randy</span><span class="p">;</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>     <span class="c1">// reduce strength</span>
<span class="lineno">25</span>     <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span> <span class="o">-=</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">damper</span><span class="p">;</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>   <span class="p">}</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>   <span class="c1">// apply some drag</span>
<span class="lineno">30</span>   <span class="p">...</span>
<span class="lineno">31</span> 
<span class="lineno">32</span>   <span class="c1">// update camera position -- verlet integration</span>
<span class="lineno">33</span>   <span class="p">...</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>   <span class="c1">// reset accel</span>
<span class="lineno">36</span>   <span class="p">...</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>   <span class="c1">// bound camera to world edges if applicable</span>
<span class="lineno">39</span>   <span class="p">...</span>
<span class="lineno">40</span> 
<span class="lineno">41</span>   <span class="c1">// update entity positions / collisions</span>
<span class="lineno">42</span>   <span class="p">...</span>
<span class="lineno">43</span> 
<span class="lineno">44</span>   <span class="c1">// update player positions / collisions</span>
<span class="lineno">45</span>   <span class="p">...</span>
<span class="lineno">46</span> 
<span class="lineno">47</span> <span class="p">}</span></code></pre></div>

<p>The random acceleration will make the camera jerk (shake) the most violent at the start, then die down due to the <code>damper</code>, and eventually the camera will return to the target position. To make this start, set the camera properties:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="c1">// start shaking!</span>
<span class="lineno">2</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">strength</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
<span class="lineno">3</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">damper</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></code></pre></div>

<p>Now the camera will shake until there is no strength left. Put this little snippet of code anywhere to trigger the shaking—on a button press, on a player collision with an asteroid, on a bullet collision with an enemy, on an explosion, etc.</p>

<p>YAY! Screen shake has now been implemented. </p>

<p>Toy around with different values for <code>strength</code> and <code>damper</code> to get the best feel for your game. Try a bunch of different tweaks; have strength be additive instead of capped for really crazy screen shaking…</p>

<h3 id="cool-how-can-i-use-this">Cool! How can I use this?</h3>

<p>Made it to the end. Nice. </p>

<p>There was a lot here to just handle shaking the screen but I think all of it was worth mentioning because it opens doors to other effects you can implemenet using a physics based simulation; you don’t have to just shake the screen, you can shake any object that acts on accelerations.</p>

<p>However, I realize that this might be hard to implement into every system, so I’ll list some main points this post covers:</p>

<ul>
  <li>Camera space is different than World space
    <ul>
      <li>a canvas drawing context <em>always</em> assumes camera space</li>
    </ul>
  </li>
  <li>The camera is just an object
    <ul>
      <li>it has position, velocity, and acceleration like everything else in your game</li>
    </ul>
  </li>
  <li>To follow an object is to define a target point for your camera
    <ul>
      <li>slowly move the camera to the target position over many frames via acceleration forces</li>
    </ul>
  </li>
  <li>Shaking the camera is the same as adding random acceleration forces to the camera</li>
</ul>

<p>Getting the camera to do what you want is really tricky. It requires a lot of trial and error to get the right “feel”, but having a camera is really important and having a camera that works and feels correct is even more important. </p>

<p>One last noteworthy topic is that while you can try to do most of these physics things yourself, consider getting a physics library; even a small one. I use <a href="https://github.com/kirbysayshi/pocket-physics">pocket-physics</a>. It’s lightweight, on npm, and handles calculating verlet integrations, drag, distance constraints, spring constratints, gravitation, allows work on vectors directly, etc; all of the cool physics-y things you’d ever want. </p>

<p>Well hopefully that made sense.</p>

<p><strong>The End.</strong></p>

<p>Wait! <em>What kind of post would this be without a demo?!</em> </p>

<p>He’s a codepen. You might have to rerun the results pane, and give the canvas focus by clicking on it once it’s reloaded. </p>

<p>(W,A,S,D to move, Shift to shake, ESC to stop animations):</p>

<div data-height="446" data-theme-id="0" data-slug-hash="ZYeMMK" data-default-tab="js" data-user="theoperatore" class="codepen"><pre><code>// camera object
var camera = {
  cpos : { x : 0, y : 0 },
  ppos : { x : 0, y : 0 },
  acel : { x : 0, y : 0 },
  height : document.body.clientHeight,
  width  : document.body.clientWidth,
  maxHeight : 6 * document.body.clientHeight,
  maxWidth  : 6 * document.body.clientWidth,
  cullDist : 300,
  bound : true,
  target : { x : 0, y : 0 }
}

// player object
var player = {
  cpos : { x : 0, y : 0 },
  ppos : { x : 0, y : 0 },
  acel : { x : 0, y : 0 }
}

// handle input
var inputs = {};
document.addEventListener(&quot;keydown&quot;, function(ev) {
  inputs[ev.keyCode] = true;
}, false);
document.addEventListener(&quot;keyup&quot;, function(ev) {
  inputs[ev.keyCode] = false;
}, false);

// init entities
var entities = [];
for (var i = 0; i &lt; 100; i++) {
  var randx = Math.random() * 6 * document.body.clientWidth;
  var randy = Math.random() * 6 * document.body.clientHeight;
  entities.push({
    cpos : { x : randx, y : randy },
    ppos : { x : randx, y : randy },
    acel : { x: 0, y : 0 }
  });
}

console.log(entities);
// canvas stuff
var cvs = document.getElementById(&quot;canvas&quot;);
cvs.width = document.body.clientWidth;
cvs.height = document.body.clientHeight;
var ctx = cvs.getContext(&#x27;2d&#x27;);

function clearBlack() {
  ctx.beginPath();
  ctx.fillStyle = &quot;black&quot;;
  ctx.fillRect(0, 0, cvs.width, cvs.height);
}
var anim;
function update() {
  anim = requestAnimationFrame(update);
  // clear screen
  clearBlack();
   
  // check inputs
  // up - w
  if (inputs[87]) {
    player.acel.y = -6;
  }

  // down - s
  else if (inputs[83]) {
    player.acel.y = 6;
  }

  // left - a
  if (inputs[65]) {
    player.acel.x = -6;
  }

  // right - d
  else if (inputs[68]) { 
    player.acel.x = 6;
  }
  
  // get the target point
  camera.target.x = player.cpos.x - (camera.width / 2);
  camera.target.y = player.cpos.y - (camera.height / 2);
  
  // move camera towards target point
  camera.acel.x += (1 / 8) * (camera.target.x - camera.cpos.x);
  camera.acel.y += (1 / 8) * (camera.target.y - camera.cpos.y);
  
  // verlet integration on player and camera
  player.ppos.x = player.cpos.x + (player.ppos.x - player.cpos.x) * 0.81;
  player.ppos.y = player.cpos.y + (player.ppos.y - player.cpos.y) * 0.81;
  player.cpos.x += player.acel.x * 0.256;
  player.cpos.y += player.acel.y * 0.256;
  var px = 2 * player.cpos.x - player.ppos.x;
  var py = 2 * player.cpos.y - player.ppos.y;
  player.ppos.x = player.cpos.x;
  player.ppos.y = player.cpos.y;
  player.cpos.x = px;
  player.cpos.y = py;
  player.acel.x = 0;
  player.acel.y = 0;
  
  camera.ppos.x = camera.cpos.x + (camera.cpos.x - camera.ppos.x) * 0.96;
  camera.ppos.y = camera.cpos.y + (camera.cpos.y - camera.ppos.y) * 0.96;
  camera.cpos.x += camera.acel.x * 0.256;
  camera.cpos.y += camera.acel.y * 0.256;
  var cx = 2 * camera.cpos.x - camera.ppos.x;
  var cy = 2 * camera.cpos.y - camera.ppos.y;
  camera.ppos.x = camera.cpos.x;
  camera.ppos.y = camera.cpos.y;
  camera.cpos.x = cx;
  camera.cpos.y = cy;
  camera.acel.x = 0;
  camera.acel.y = 0;

  if (camera.bound) {

    // flush camera -- x bounds
    camera.cpos.x = Math.min(camera.cpos.x, camera.maxWidth - camera.width);
    camera.cpos.x = Math.max(camera.cpos.x, 0);

    // flush camera -- y bounds
    camera.cpos.y = Math.min(camera.cpos.y, camera.maxHeight - camera.height);
    camera.cpos.y = Math.max(camera.cpos.y, 0);
  }
  
  // draw stuff
  var playerx = player.cpos.x - camera.cpos.x;
  var playery = player.cpos.y - camera.cpos.y;
  ctx.beginPath();
  ctx.fillStyle = &quot;white&quot;;
  ctx.fillRect(playerx, playery, 10, 10);
  
  for (var i = 0; i &lt; entities.length; i++) {
    var entity = entities[i];
    var ex = entity.cpos.x - camera.cpos.x;
    var ey = entity.cpos.y - camera.cpos.y;
    ctx.beginPath();
    ctx.fillStyle=&quot;gold&quot;;
    ctx.arc(ex,ey, 10, 0, 2*Math.PI, false);
    ctx.fill();
  }
}


anim = requestAnimationFrame(update);
document.addEventListener(&quot;keydown&quot;, function(ev) {
  if (ev.keyCode === 27) {
    cancelAnimationFrame(anim);
  }
});</code></pre>
<p>See the Pen <a href="http://codepen.io/theoperatore/pen/ZYeMMK/">2d physics camera with screen shake!</a> by Alex Petersen (<a href="http://codepen.io/theoperatore">@theoperatore</a>) on <a href="http://codepen.io">CodePen</a>.</p>
</div>
<script async="" src="//assets.codepen.io/assets/embed/ei.js"></script>

<p>Now it’s the end for real, thanks for reading!</p>


</div>
</div>
        <footer>

  <div class="me">
    <div class="highlight-img">
      <div class="me-img">
        <img src="/assets/me-img.png"/>
        <img class="easter-egg" src="/assets/nu-side.png"/>
      </div>
    </div>
    <div>
      <div class="me-description">
        <p>Heyo! I'm Alex.</p>
        <p>I try to write about neat things&mdash;mainly programming things and thoughts on games I'm playing right now</p>
        <p>I code with the mantra "Make anything cool today?"</p>
        <a href="https://github.com/theoperatore"><img src="/assets/GitHub-Mark.svg"/></a>
        <a href="https://twitter.com/theoperatore"><img src="/assets/twitter.svg"/></a>
        <a href="mailto:theoperatore@gmail.com"><img src="/assets/envelope.svg"/></a>

      </div>
    </div>
  </div> 


  &copy;2014 -- Made using <a target="_blank" href='http://jekyllrb.com/'>Jekyll</a> hosted on <a target='_blank' href='http://pages.github.com/'>GitHub</a>
</footer>
      </div>


      <script type="text/javascript">

        document.getElementById('menu-toggle').addEventListener('click', function() {

          document.getElementById('nav').classList.toggle('show');

        }, false);

      </script>   
    </body>
</html>
